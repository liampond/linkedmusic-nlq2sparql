PREFIX ts: <https://linkedmusic.ca/graphs/thesession/>
PREFIX wdt: <http://www.wikidata.org/prop/direct/>
PREFIX rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#>
PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>

SELECT ?capital ?capitalLabel
WHERE {
  # 1. Subquery to find the Country URI with the highest number of sessions.
  # This avoids SP031 by ensuring ?country is bound before the SERVICE call.
  {
    SELECT ?country
    WHERE {
      GRAPH <https://linkedmusic.ca/graphs/thesession/> {
        ?session rdf:type ts:Session .
        ?session wdt:P17 ?country .
      }
    }
    GROUP BY ?country
    ORDER BY DESC(COUNT(?session))
    LIMIT 1
  }

  # 2. Federated query to Wikidata to get the capital of that country.
  SERVICE <https://query.wikidata.org/sparql> {
    ?country wdt:P36 ?capital .
    ?capital rdfs:label ?capitalLabel .
    FILTER(LANG(?capitalLabel) = "en")
  }
}