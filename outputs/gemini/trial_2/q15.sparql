PREFIX dtl: <https://linkedmusic.ca/graphs/dig-that-lick/>
PREFIX wdt: <http://www.wikidata.org/prop/direct/>
PREFIX rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#>
PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>

SELECT ?gender ?genderLabel (COUNT(?solo) AS ?soloCount)
WHERE {
  # Subquery to resolve local entities and their Wikidata links first
  # This prevents the Virtuoso SP031 error by establishing scope
  {
    SELECT ?solo ?wdPerformer
    WHERE {
      GRAPH <https://linkedmusic.ca/graphs/dig-that-lick/> {
        # Verify the type of the entity
        ?solo rdf:type dtl:Solo .
        
        # Get the performer of the solo
        ?solo wdt:P175 ?performer .
        
        # Get the reconciled Wikidata entity for the performer
        ?performer wdt:P2888 ?wdPerformer .
      }
    }
  }

  # Federated query to retrieve gender information from Wikidata
  SERVICE <https://query.wikidata.org/sparql> {
    ?wdPerformer wdt:P21 ?gender .
    ?gender rdfs:label ?genderLabel .
    FILTER(LANG(?genderLabel) = "en")
  }
}
GROUP BY ?gender ?genderLabel
ORDER BY DESC(?soloCount)